# Copyright 2025 DataRobot, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
from datarobot_pulumi_utils.pulumi import export

from .__{{ llm_app_name|lower|replace('-','_')}}__ import (
    validate_feature_flags, verify_llm, verify_llm_gateway_model_availability
)

REQUIRED_FEATURE_FLAGS = {
    "ENABLE_LLM_GATEWAY": True,
    "ENABLE_MLOPS": True,
    "ENABLE_CUSTOM_INFERENCE_MODEL": True,
    "ENABLE_PUBLIC_NETWORK_ACCESS_FOR_ALL_CUSTOM_MODELS": True,
    "ENABLE_MLOPS_TEXT_GENERATION_TARGET_TYPE": True,
    "ENABLE_MLOPS_RESOURCE_REQUEST_BUNDLES": True
}

default_llm: str = "azure/gpt-4o-2024-11-20"

# Verify everything is working
validate_feature_flags(REQUIRED_FEATURE_FLAGS)
verify_llm_gateway_model_availability(default_llm)
verify_llm(f"datrobot/{default_llm}")

app_runtime_parameters = [
    datarobot.ApplicationSourceRuntimeParameterValueArgs(
        key="USE_DATAROBOT_LLM_GATEWAY",
        type="boolean",
        value=True,
    ),
    datarobot.ApplicationSourceRuntimeParameterValueArgs(
        key={{llm_app_name}}_application_name.upper() + "_MODEL_ID",
        type="string",
        value=default_llm,
    ),
]

pulumi.export("Deployment ID " + {{llm_app_name}}_resource_name, llm_deployment.id)
export("USE_DATAROBOT_LLM_GATEWAY", "1")
