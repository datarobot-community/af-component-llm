version: '3'
env:
  RENDER_DIR: .rendered
tasks:
  lint-check:
    desc: ðŸ§¹ Check whether the codebase is linted
    cmds:
        - echo "ðŸ§¹ Linting"
        - task: install-dev
        - cd ./$RENDER_DIR/infra && uv run ruff format --check --diff .
        - cd ./$RENDER_DIR/infra && uv run ruff check --diff .
        - cd ./$RENDER_DIR/infra && uv tool run ty@0.0.1a34 check --verbose .
  validate-windows-compatibility:
    desc: "Validate that file paths don't contain characters illegal on Windows"
    cmds:
      - cmd: |
          echo "Scanning for Windows-incompatible file names (<>:\"|?*)..."
          total=$(find ./template -type f | wc -l | tr -d ' ')
          failures=$(find ./template -type f | while IFS= read -r f; do
            if echo "$f" | grep -q '[<>:"|?*]'; then
              echo "FAIL: $f" >&2
              echo "$f"
            else
              echo "  ok: $f" >&2
            fi
          done)
          bad=0
          if [ -n "$failures" ]; then
            bad=$(echo "$failures" | wc -l | tr -d ' ')
            echo ""
            echo "Offending files:"
            echo "$failures"
          fi
          echo ""
          echo "Checked $total files, $bad incompatible."
          [ "$bad" -gt 0 ] && exit 1 || true
        platforms: [linux, darwin]

  copyright:
    aliases: [license]
    desc: ðŸ“œ Apply license headers
    cmds:
      - echo "ðŸ“œ Applying license headers"
      - docker run  --rm -v $PWD:/github/workspace ghcr.io/apache/skywalking-eyes/license-eye:eb0e0b091ea41213f712f622797e37526ca1e5d6 -v info -c .licenserc.yaml header fix
  copyright-check:
    aliases: [license-check]
    desc: ðŸ“œ Checking for license headers
    cmds:
      - echo "ðŸ“œ Checking license headers"
      - docker run  --rm -v $PWD:/github/workspace ghcr.io/apache/skywalking-eyes/license-eye:eb0e0b091ea41213f712f622797e37526ca1e5d6 -v info -c .licenserc.yaml header check
  render-template:
    desc: "Render template"
    cmds:
      - echo "Rendering template"
      # Clean up the existing rendered directory except for .venv to speed up rendering and avoid conflict checks
      - cd ./$RENDER_DIR/ && [ -d . ] && find . -mindepth 1 -maxdepth 1 ! -name '.venv' -exec rm -rf {} + || true
      - uvx copier copy . ./$RENDER_DIR --defaults --vcs-ref=HEAD
      - cp ./fixtures/infra/pyproject.toml ./$RENDER_DIR/infra/pyproject.toml
      - cp ./fixtures/infra/__init__.py ./$RENDER_DIR/infra/infra/__init__.py
      - cp ./fixtures/infra/Pulumi.yaml ./$RENDER_DIR/infra/Pulumi.yaml
      - touch ./$RENDER_DIR/infra/__init__.py
  install-dev:
    desc: "Install dev"
    cmds:
      - echo "Installing dev for LLM"
      - task: render-template
      - cd ./$RENDER_DIR/infra && uv sync --extra dev --quiet
